<div data-ng-if="!AdvancedCtrl.Donor.donors || ! AdvancedCtrl.Donor.hitsLoaded || AdvancedCtrl.Donor.isLoading" class="loading loading-text"><h3><i class="icon-spinner icon-spin"></i>
    <translate>Loading Donors...</translate>
</h3></div>
<div data-ng-if="AdvancedCtrl.Donor.donors.hits.length == 0 && AdvancedCtrl.Donor.hitsLoaded && ! AdvancedCtrl.Donor.isLoading" class="empty loading-text"><h3><translate>No Donors Found.</translate></h3></div>
<div data-ng-show="AdvancedCtrl.Donor.donors.hits.length && AdvancedCtrl.Donor.hitsLoaded && ! AdvancedCtrl.Donor.isLoading">
    <section class="graphs-container" style="position:relative;">
        <div data-ng-class="{'graphs-collapsed': !donorExpand}" class="graphs">
            <div class="row">
                <pie class="col-md-3 col-sm-6" items='AdvancedCtrl.Donor.pieProjectId' heading="{{'Project' | translate}}" label="{{'Donors' | translate}}" type="pie" width="195" group-percent="3"
                 height="150"></pie>
                <pie class="col-md-3 col-sm-6" items='AdvancedCtrl.Donor.piePrimarySite' heading="{{'Primary Site' | translate}}" label="{{'Donors' | translate}}" type="pie" width="195"
                    height="150"></pie>
                <pie class="col-md-3 col-sm-6" items='AdvancedCtrl.Donor.pieGender' heading="{{'Gender' | translate}}" label="{{'Donors' | translate}}" type="pie" width="195"
                    height="150"></pie>
                <pie class="col-md-3 col-sm-6" items='AdvancedCtrl.Donor.pieAge' heading="{{'Age' | translate}}" label="{{'Donors' | translate}}" type="pie" width="195"
                    height="150"></pie>
            </div>
            <div class="row" style="margin-top:20px;">
                <span class="col-md-6 col-sm-12">
                    <bar
                        config-overrides="AdvancedCtrl.donorDataTypeChartConfig"
                        items="AdvancedCtrl.Donor.barDataTypes"
                        heading="{{'Data Types' | translate}}"
                        ylabel="{{'# of Donors' | translate}}"
                        type="bar"
                        width="390"
                        height="150"
                        style="padding-left: 25px;"
                        >
                    </bar>
                </span>
                <span class="col-md-6 col-sm-12">
                    <bar
                        config-overrides="AdvancedCtrl.donorAnalysisTypeChartConfig"
                        items="AdvancedCtrl.Donor.barAnalysisTypes"
                        heading="{{'Analysis Types' | translate}}"
                        ylabel="{{'# of Donors' | translate}}"
                        type="bar"
                        width="390"
                        height="150"
                        style="padding-left: 25px;"
                        >
                    </bar>
                </span>
            </div>
        </div>
        <div class="more-graphs-wrap">
            <span
                data-ng-click="donorExpand=!donorExpand; track('viz-filter-show-more', { action: 'click' })"
                class="more-graphs t_tools__tool"
            >
                <span data-ng-if="!donorExpand"><i class="icon-angle-down"></i> <translate>Show More</translate></span>
                <span data-ng-if="donorExpand"><i class="icon-angle-up"></i> <translate>Show Less</translate></span>
            </span>
            <div class="teaser-coverup"></div>
        </div>
    </section>
    <section>
        <h3>
            <translate>Donors</translate>
            <span class="action-toolbar pull-right">
                <span class="action-item">
                    <i class="icon-grid"></i>
                    <a
                        href="#"
                        data-ng-click="
                            AdvancedCtrl.oncogridAnalysis();
                            track('advanced-search-links', { action: 'click-oncogrid' });
                        "
                    >
                        <translate>OncoGrid</translate>
                    </a>
               </span>
               <span class="action-item">
                    <entityset-persistence-dropdown
                        selected-entity-ids="AdvancedCtrl.selectedEntityIdsMap.donor"
                        entity-type="'donor'"
                        set-total-count="AdvancedCtrl.Donor.donors.pagination.total"
                        set-limit="ICGC_SETTINGS.maxNumberOfHits"
                        on-operation-success="AdvancedCtrl.handleOperationSuccess('donor')"
                    ></entityset-persistence-dropdown>
               </span>
            </span>
        </h3>

        <div class="t_table_top">
            <span data-table-counts data-label="{{'donors' | translate}}" data-page="AdvancedCtrl.Donor.donors.pagination"></span>
            <span 
                data-toolbar 
                data-entity="donors"
                data-json="{{ AdvancedCtrl.Donor.donors.hits }}"></span>
        </div>
        <table class="table table-bordered table-striped table-condensed">
            <thead>
            <tr>
                <th rowspan="2"></th>
                <th rowspan="2" data-sortable data-type="donors" data-field="id">ID
                </th>
                <th rowspan="2" data-sortable data-type="donors" data-field="projectId"><translate>Project</translate></th>
                <th rowspan="2" data-sortable data-type="donors" data-field="primarySite"><translate>Site</translate></th>
                <th rowspan="2" data-sortable data-type="donors" data-field="gender"><translate>Gender</translate></th>
                <th rowspan="2" data-sortable data-type="donors" data-field="ageAtDiagnosis" class="text-center">
                    <abbr data-icgc-tooltip="{{'Age at Enrollment' | translate}}"><translate>Age</translate></abbr>
                </th>
                <th colspan="3" class="text-center"><translate>Available Data Types:</translate></th>
                <th rowspan="2">
                    <abbr data-icgc-tooltip="{{'Number of SSM<br>Filtered by Current Search Criteria' | translate}}"><translate># Mutations</translate></abbr></th>
                <th rowspan="2" data-sortable data-type="donors" data-field="ssmAffectedGenes" data-active="true"
                    data-reversed="true">
                    <abbr data-icgc-tooltip="{{'Number of Genes with SSM<br>Filtered by Current Search Criteria' | translate}}"
                          data-tooltip-placement="left"><translate># Genes</translate></abbr>
                </th>
            </tr>
            <tr>
                <th class="text-center" data-type="donors" data-field="ssmCount"><abbr
                        data-icgc-tooltip="{{ 'ssm' | datatype }}" class="tiny-header">SSM</abbr></th>
                <th class="text-center" data-type="donors" data-field="cnsmExists"><abbr
                        data-icgc-tooltip="{{ 'cnsm' | datatype }}" class="tiny-header">CNSM</abbr></th>
                <th class="text-center" data-type="donors" data-field="stsmExists"><abbr
                        data-icgc-tooltip="{{ 'stsm' | datatype}}" class="tiny-header">StSM</abbr></th>
            </tr>
            </thead>
            <tbody>
            <tr
                ng-class="{
                    'is-selected': AdvancedCtrl.isEntitySelected('donor', donor)
                }"
                data-ng-repeat="donor in AdvancedCtrl.Donor.donors.hits track by donor.id"
            >
                <td ng-click="AdvancedCtrl.toggleSelectedEntity('donor', donor)">
                    <icgc-checkbox is-checked="AdvancedCtrl.isEntitySelected('donor', donor)"></icgc-checkbox>
                </td>
                <td><a href="/donors/{{ donor.id }}">{{ donor.id }}</a></td>
                <td>
                    <a data-icgc-tooltip="{{ donor.projectName }}" data-tooltip-placement="top" href="/projects/{{ donor.projectId }}">
                        {{ donor.projectId }}
                    </a>
                </td>
                <td>{{ donor.primarySite }}</td>
                <td>{{ donor.gender | readable }}</td>
                <td class="text-right">{{ donor.ageAtDiagnosis }}</td>
                <td style="text-align:center">
                    <span data-exists="donor.ssmCount"></span>
                </td>
                <td style="text-align: center">
                    <span data-exists="true"></span>
                </td>
                <td style="text-align: center">
                    <span data-exists="true"></span>
                </td>
                <td class="text-right">
                    <span data-ng-if="!AdvancedCtrl.Donor.mutationCounts"><i class="icon-spinner icon-spin"></i></span>
                    <span data-ng-if="AdvancedCtrl.Donor.mutationCounts[donor.id] === 0">--</span>
                    <a data-ng-if="AdvancedCtrl.Donor.mutationCounts[donor.id] > 0"
                       href="search/m?filters={{ donor.embedQuery }}">
                        {{ AdvancedCtrl.Donor.mutationCounts[donor.id] | numberPT }}</a>
                </td>
                <td class="text-right" style="position: relative">
                    <span data-ng-if="donor.ssmAffectedGenes === 0">--</span>
                    <a data-ng-if="donor.ssmAffectedGenes > 0"
                       href="search/g?filters={{ donor.embedQuery }}">
                        {{ donor.ssmAffectedGenes | numberPT }}</a>
                </td>
            </tr>
            </tbody>
        </table>
        <pagination-controls data-type="donors" data-data="AdvancedCtrl.Donor.donors"></pagination-controls>


        <table class="hidden" id="donors" data-ng-if="AdvancedCtrl.Page.isExporting()">
            <thead>
            <tr>
                <td><translate>Donor ID</translate></td>
                <td><translate>Project Code</translate></td>
                <td><translate>Primary Site</translate></td>
                <td><translate>Gender</translate></td>
                <td><translate>Age at Enrollment</translate></td>
                <td>SSM</td>
                <td>CNSM</td>
                <td>STSM</td>
                <td><translate>Mutations</translate></td>
                <td><translate>Mutated Genes</translate></td>
            </tr>
            </thead>
            <tbody>
            <tr data-ng-repeat="donor in AdvancedCtrl.Donor.donors.hits track by donor.id">
                <td>{{ donor.id }}</td>
                <td>{{ donor.projectId }}</td>
                <td>{{ donor.primarySite }}</td>
                <td>{{ donor.gender | readable }}</td>
                <td>{{ donor.ageAtDiagnosis }}</td>
                <td>{{ donor.ssmCount? 'True': 'False' }} </td>
                <td>True</td>
                <td>True</td>
                <td>{{ AdvancedCtrl.Donor.mutationCounts[donor.id] }}</td>
                <td>{{ donor.ssmAffectedGenes | numberPT }}</td>
            </tr>
            </tbody>
        </table>
    </section>
</div>
